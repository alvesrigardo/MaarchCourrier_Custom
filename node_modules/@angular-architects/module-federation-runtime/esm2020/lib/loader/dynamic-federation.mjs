let config = {};
const containerMap = {};
const remoteMap = {};
let isDefaultScopeInitialized = false;
async function lookupExposedModule(key, exposedModule) {
    const container = containerMap[key];
    const factory = await container.get(exposedModule);
    const Module = factory();
    return Module;
}
async function initRemote(container, key) {
    // const container = window[key] as Container;
    // Do we still need to initialize the remote?
    if (remoteMap[key]) {
        return container;
    }
    // Do we still need to initialize the share scope?
    if (!isDefaultScopeInitialized) {
        await __webpack_init_sharing__('default');
        isDefaultScopeInitialized = true;
    }
    await container.init(__webpack_share_scopes__.default);
    remoteMap[key] = true;
    return container;
}
export async function loadRemoteEntry(remoteEntryOrOptions, remoteName) {
    if (typeof remoteEntryOrOptions === 'string') {
        const remoteEntry = remoteEntryOrOptions;
        return await loadRemoteScriptEntry(remoteEntry, remoteName);
    }
    else if (remoteEntryOrOptions.type === 'script') {
        const options = remoteEntryOrOptions;
        return await loadRemoteScriptEntry(options.remoteEntry, options.remoteName);
    }
    else if (remoteEntryOrOptions.type === 'module') {
        const options = remoteEntryOrOptions;
        await loadRemoteModuleEntry(options.remoteEntry);
    }
}
async function loadRemoteModuleEntry(remoteEntry) {
    if (containerMap[remoteEntry]) {
        return Promise.resolve();
    }
    return await import(/* webpackIgnore:true */ remoteEntry).then((container) => {
        initRemote(container, remoteEntry);
        containerMap[remoteEntry] = container;
    });
}
async function loadRemoteScriptEntry(remoteEntry, remoteName) {
    return new Promise((resolve, reject) => {
        // Is remoteEntry already loaded?
        if (containerMap[remoteName]) {
            resolve();
            return;
        }
        const script = document.createElement('script');
        script.src = remoteEntry;
        script.onerror = reject;
        script.onload = () => {
            const container = window[remoteName];
            initRemote(container, remoteName);
            containerMap[remoteName] = container;
            resolve();
        };
        document.body.appendChild(script);
    });
}
// eslint-disable-next-line @typescript-eslint/no-explicit-any
export async function loadRemoteModule(options) {
    let loadRemoteEntryOptions;
    let key;
    let remoteEntry;
    // To support legacy API (< ng 13)
    if (!options.type) {
        options.type = 'script';
    }
    if (options.type === 'manifest') {
        const manifestEntry = config[options.remoteName];
        if (!manifestEntry) {
            throw new Error('Manifest does not contain ' + options.remoteName);
        }
        options = {
            type: manifestEntry.type,
            exposedModule: options.exposedModule,
            remoteEntry: manifestEntry.remoteEntry,
            remoteName: manifestEntry.type === 'script' ? options.remoteName : undefined,
        };
        remoteEntry = manifestEntry.remoteEntry;
    }
    else {
        remoteEntry = options.remoteEntry;
    }
    if (options.type === 'script') {
        loadRemoteEntryOptions = {
            type: 'script',
            remoteEntry: options.remoteEntry,
            remoteName: options.remoteName,
        };
        key = options.remoteName;
    }
    else if (options.type === 'module') {
        loadRemoteEntryOptions = {
            type: 'module',
            remoteEntry: options.remoteEntry,
        };
        key = options.remoteEntry;
    }
    if (remoteEntry) {
        await loadRemoteEntry(loadRemoteEntryOptions);
    }
    return await lookupExposedModule(key, options.exposedModule);
}
export async function setManifest(manifest, skipRemoteEntries = false) {
    config = parseConfig(manifest);
    if (!skipRemoteEntries) {
        await loadRemoteEntries();
    }
}
export function getManifest() {
    return config;
}
export async function loadManifest(configFile, skipRemoteEntries = false) {
    const result = await fetch(configFile);
    if (!result.ok) {
        throw Error('could not load configFile: ' + configFile);
    }
    config = parseConfig(await result.json());
    if (!skipRemoteEntries) {
        await loadRemoteEntries();
    }
}
function parseConfig(config) {
    const result = {};
    for (let key in config) {
        const value = config[key];
        let entry;
        if (typeof value === 'string') {
            entry = {
                remoteEntry: value,
                type: 'module',
            };
        }
        else {
            entry = {
                ...value,
                type: value.type || 'module',
            };
        }
        result[key] = entry;
    }
    return result;
}
async function loadRemoteEntries() {
    const promises = [];
    for (let key in config) {
        const entry = config[key];
        if (entry.type === 'module') {
            promises.push(loadRemoteEntry({ type: 'module', remoteEntry: entry.remoteEntry }));
        }
        else {
            promises.push(loadRemoteEntry({
                type: 'script',
                remoteEntry: entry.remoteEntry,
                remoteName: key,
            }));
        }
    }
    await Promise.all(promises);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mZWRlcmF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9tZi1ydW50aW1lL3NyYy9saWIvbG9hZGVyL2R5bmFtaWMtZmVkZXJhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFTQSxJQUFJLE1BQU0sR0FBYSxFQUFFLENBQUM7QUFxQjFCLE1BQU0sWUFBWSxHQUFpQixFQUFFLENBQUM7QUFDdEMsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO0FBRXJCLElBQUkseUJBQXlCLEdBQUcsS0FBSyxDQUFDO0FBRXRDLEtBQUssVUFBVSxtQkFBbUIsQ0FDaEMsR0FBVyxFQUNYLGFBQXFCO0lBRXJCLE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQyxNQUFNLE9BQU8sR0FBRyxNQUFNLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDbkQsTUFBTSxNQUFNLEdBQUcsT0FBTyxFQUFFLENBQUM7SUFDekIsT0FBTyxNQUFXLENBQUM7QUFDckIsQ0FBQztBQUVELEtBQUssVUFBVSxVQUFVLENBQUMsU0FBb0IsRUFBRSxHQUFXO0lBQ3pELDhDQUE4QztJQUU5Qyw2Q0FBNkM7SUFDN0MsSUFBSSxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDbEIsT0FBTyxTQUFTLENBQUM7S0FDbEI7SUFFRCxrREFBa0Q7SUFDbEQsSUFBSSxDQUFDLHlCQUF5QixFQUFFO1FBQzlCLE1BQU0sd0JBQXdCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDMUMseUJBQXlCLEdBQUcsSUFBSSxDQUFDO0tBQ2xDO0lBRUQsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZELFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDdEIsT0FBTyxTQUFTLENBQUM7QUFDbkIsQ0FBQztBQXdCRCxNQUFNLENB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QUFRLEdBQW9CLEVBQUUsQ0FBQztJQUVyQyxLQUFLLElBQUksR0FBRyxJQUFJLE1BQU0sRUFBRTtRQUN0QixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFMUIsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUMzQixRQUFRLENBQUMsSUFBSSxDQUNYLGVBQWUsQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUNwRSxDQUFDO1NBQ0g7YUFBTTtZQUNMLFFBQVEsQ0FBQyxJQUFJLENBQ1gsZUFBZSxDQUFDO2dCQUNkLElBQUksRUFBRSxRQUFRO2dCQUNkLFdBQVcsRUFBRSxLQUFLLENBQUMsV0FBVztnQkFDOUIsVUFBVSxFQUFFLEdBQUc7YUFDaEIsQ0FBQyxDQUNILENBQUM7U0FDSDtLQUNGO0lBRUQsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzlCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJ0eXBlIFNjb3BlID0gdW5rbm93bjtcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG50eXBlIEZhY3RvcnkgPSAoKSA9PiBhbnk7XG5cbnR5cGUgQ29udGFpbmVyID0ge1xuICBpbml0KHNoYXJlU2NvcGU6IFNjb3BlKTogdm9pZDtcbiAgZ2V0KG1vZHVsZTogc3RyaW5nKTogRmFjdG9yeTtcbn07XG5cbmxldCBjb25maWc6IE1hbmlmZXN0ID0ge307XG5cbmV4cG9ydCB0eXBlIE1hbmlmZXN0RmlsZTxUIGV4dGVuZHMgUmVtb3RlQ29uZmlnID0gUmVtb3RlQ29uZmlnPiA9IHtcbiAgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgVDtcbn07XG5cbmV4cG9ydCB0eXBlIE1hbmlmZXN0PFQgZXh0ZW5kcyBSZW1vdGVDb25maWcgPSBSZW1vdGVDb25maWc+ID0ge1xuICBba2V5OiBzdHJpbmddOiBUO1xufTtcblxuZXhwb3J0IHR5cGUgUmVtb3RlQ29uZmlnID0ge1xuICB0eXBlOiAnbW9kdWxlJyB8ICdzY3JpcHQnO1xuICByZW1vdGVFbnRyeTogc3RyaW5nO1xuICBba2V5OiBzdHJpbmddOiB1bmtub3duO1xufTtcblxuZGVjbGFyZSBjb25zdCBfX3dlYnBhY2tfaW5pdF9zaGFyaW5nX186IChzaGFyZVNjb3BlOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD47XG5kZWNsYXJlIGNvbnN0IF9fd2VicGFja19zaGFyZV9zY29wZXNfXzogeyBkZWZhdWx0OiBTY29wZSB9O1xuXG50eXBlIENvbnRhaW5lck1hcCA9IHsgW2tleTogc3RyaW5nXTogQ29udGFpbmVyIH07XG5cbmNvbnN0IGNvbnRhaW5lck1hcDogQ29udGFpbmVyTWFwID0ge307XG5jb25zdCByZW1vdGVNYXAgPSB7fTtcblxubGV0IGlzRGVmYXVsdFNjb3BlSW5pdGlhbGl6ZWQgPSBmYWxzZTtcblxuYXN5bmMgZnVuY3Rpb24gbG9va3VwRXhwb3NlZE1vZHVsZTxUPihcbiAga2V5OiBzdHJpbmcsXG4gIGV4cG9zZWRNb2R1bGU6IHN0cmluZ1xuKTogUHJvbWlzZTxUPiB7XG4gIGNvbnN0IGNvbnRhaW5lciA9IGNvbnRhaW5lck1hcFtrZXldO1xuICBjb25zdCBmYWN0b3J5ID0gYXdhaXQgY29udGFpbmVyLmdldChleHBvc2VkTW9kdWxlKTtcbiAgY29uc3QgTW9kdWxlID0gZmFjdG9yeSgpO1xuICByZXR1cm4gTW9kdWxlIGFzIFQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXRSZW1vdGUoY29udGFpbmVyOiBDb250YWluZXIsIGtleTogc3RyaW5nKSB7XG4gIC8vIGNvbnN0IGNvbnRhaW5lciA9IHdpbmRvd1trZXldIGFzIENvbnRhaW5lcjtcblxuICAvLyBEbyB3ZSBzdGlsbCBuZWVkIHRvIGluaXRpYWxpemUgdGhlIHJlbW90ZT9cbiAgaWYgKHJlbW90ZU1hcFtrZXldKSB7XG4gICAgcmV0dXJuIGNvbnRhaW5lcjtcbiAgfVxuXG4gIC8vIERvIHdlIHN0aWxsIG5lZWQgdG8gaW5pdGlhbGl6ZSB0aGUgc2hhcmUgc2NvcGU/XG4gIGlmICghaXNEZWZhdWx0U2NvcGVJbml0aWFsaXplZCkge1xuICAgIGF3YWl0IF9fd2VicGFja19pbml0X3NoYXJpbmdfXygnZGVmYXVsdCcpO1xuICAgIGlzRGVmYXVsdFNjb3BlSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICB9XG5cbiAgYXdhaXQgY29udGFpbmVyLmluaXQoX193ZWJwYWNrX3NoYXJlX3Njb3Blc19fLmRlZmF1bHQpO1xuICByZW1vdGVNYXBba2V5XSA9IHRydWU7XG4gIHJldHVybiBjb250YWluZXI7XG59XG5cbmV4cG9ydCB0eXBlIExvYWRSZW1vdGVFbnRyeU9wdGlvbnMgPVxuICB8IExvYWRSZW1vdGVFbnRyeVNjcmlwdE9wdGlvbnNcbiAgfCBMb2FkUmVtb3RlRW50cnlFc21PcHRpb25zO1xuXG5leHBvcnQgdHlwZSBMb2FkUmVtb3RlRW50cnlTY3JpcHRPcHRpb25zID0ge1xuICB0eXBlPzogJ3NjcmlwdCc7XG4gIHJlbW90ZUVudHJ5OiBzdHJpbmc7XG4gIHJlbW90ZU5hbWU6IHN0cmluZztcbn07XG5cbmV4cG9ydCB0eXBlIExvYWRSZW1vdGVFbnRyeUVzbU9wdGlvbnMgPSB7XG4gIHR5cGU6ICdtb2R1bGUnO1xuICByZW1vdGVFbnRyeTogc3RyaW5nO1xufTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvYWRSZW1vdGVFbnRyeShcbiAgcmVtb3RlRW50cnk6IHN0cmluZyxcbiAgcmVtb3RlTmFtZTogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+O1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxvYWRSZW1vdGVFbnRyeShcbiAgb3B0aW9uczogTG9hZFJlbW90ZUVudHJ5T3B0aW9uc1xuKTogUHJvbWlzZTx2b2lkPjtcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkUmVtb3RlRW50cnkoXG4gIHJlbW90ZUVudHJ5T3JPcHRpb25zOiBzdHJpbmcgfCBMb2FkUmVtb3RlRW50cnlPcHRpb25zLFxuICByZW1vdGVOYW1lPzogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgaWYgKHR5cGVvZiByZW1vdGVFbnRyeU9yT3B0aW9ucyA9PT0gJ3N0cmluZycpIHtcbiAgICBjb25zdCByZW1vdGVFbnRyeSA9IHJlbW90ZUVudHJ5T3JPcHRpb25zO1xuICAgIHJldHVybiBhd2FpdCBsb2FkUmVtb3RlU2NyaXB0RW50cnkocmVtb3RlRW50cnksIHJlbW90ZU5hbWUpO1xuICB9IGVsc2UgaWYgKHJlbW90ZUVudHJ5T3JPcHRpb25zLnR5cGUgPT09ICdzY3JpcHQnKSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHJlbW90ZUVudHJ5T3JPcHRpb25zO1xuICAgIHJldHVybiBhd2FpdCBsb2FkUmVtb3RlU2NyaXB0RW50cnkob3B0aW9ucy5yZW1vdGVFbnRyeSwgb3B0aW9ucy5yZW1vdGVOYW1lKTtcbiAgfSBlbHNlIGlmIChyZW1vdGVFbnRyeU9yT3B0aW9ucy50eXBlID09PSAnbW9kdWxlJykge1xuICAgIGNvbnN0IG9wdGlvbnMgPSByZW1vdGVFbnRyeU9yT3B0aW9ucztcbiAgICBhd2FpdCBsb2FkUmVtb3RlTW9kdWxlRW50cnkob3B0aW9ucy5yZW1vdGVFbnRyeSk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gbG9hZFJlbW90ZU1vZHVsZUVudHJ5KHJlbW90ZUVudHJ5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgaWYgKGNvbnRhaW5lck1hcFtyZW1vdGVFbnRyeV0pIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cbiAgcmV0dXJuIGF3YWl0IGltcG9ydCgvKiB3ZWJwYWNrSWdub3JlOnRydWUgKi8gcmVtb3RlRW50cnkpLnRoZW4oXG4gICAgKGNvbnRhaW5lcikgPT4ge1xuICAgICAgaW5pdFJlbW90ZShjb250YWluZXIsIHJlbW90ZUVudHJ5KTtcbiAgICAgIGNvbnRhaW5lck1hcFtyZW1vdGVFbnRyeV0gPSBjb250YWluZXI7XG4gICAgfVxuICApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBsb2FkUmVtb3RlU2NyaXB0RW50cnkoXG4gIHJlbW90ZUVudHJ5OiBzdHJpbmcsXG4gIHJlbW90ZU5hbWU6IHN0cmluZ1xuKTogUHJvbWlzZTx2b2lkPiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgLy8gSXMgcmVtb3RlRW50cnkgYWxyZWFkeSBsb2FkZWQ/XG4gICAgaWYgKGNvbnRhaW5lck1hcFtyZW1vdGVOYW1lXSkge1xuICAgICAgcmVzb2x2ZSgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgIHNjcmlwdC5zcmMgPSByZW1vdGVFbnRyeTtcblxuICAgIHNjcmlwdC5vbmVycm9yID0gcmVqZWN0O1xuXG4gICAgc2NyaXB0Lm9ubG9hZCA9ICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHdpbmRvd1tyZW1vdGVOYW1lXSBhcyBDb250YWluZXI7XG4gICAgICBpbml0UmVtb3RlKGNvbnRhaW5lciwgcmVtb3RlTmFtZSk7XG4gICAgICBjb250YWluZXJNYXBbcmVtb3RlTmFtZV0gPSBjb250YWluZXI7XG4gICAgICByZXNvbHZlKCk7XG4gICAgfTtcblxuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTtcbiAgfSk7XG59XG5cbmV4cG9ydCB0eXBlIExvYWRSZW1vdGVNb2R1bGVPcHRpb25zID1cbiAgfCBMb2FkUmVtb3RlTW9kdWxlU2NyaXB0T3B0aW9uc1xuICB8IExvYWRSZW1vdGVNb2R1bGVFc21PcHRpb25zXG4gIHwgTG9hZFJlbW90ZU1vZHVsZU1hbmlmZXN0T3B0aW9ucztcblxuZXhwb3J0IHR5cGUgTG9hZFJlbW90ZU1vZHVsZVNjcmlwdE9wdGlvbnMgPSB7XG4gIHR5cGU/OiAnc2NyaXB0JztcbiAgcmVtb3RlRW50cnk/OiBzdHJpbmc7XG4gIHJlbW90ZU5hbWU6IHN0cmluZztcbiAgZXhwb3NlZE1vZHVsZTogc3RyaW5nO1xufTtcblxuZXhwb3J0IHR5cGUgTG9hZFJlbW90ZU1vZHVsZUVzbU9wdGlvbnMgPSB7XG4gIHR5cGU6ICdtb2R1bGUnO1xuICByZW1vdGVFbnRyeTogc3RyaW5nO1xuICBleHBvc2VkTW9kdWxlOiBzdHJpbmc7XG59O1xuXG5leHBvcnQgdHlwZSBMb2FkUmVtb3RlTW9kdWxlTWFuaWZlc3RPcHRpb25zID0ge1xuICB0eXBlOiAnbWFuaWZlc3QnO1xuICByZW1vdGVOYW1lOiBzdHJpbmc7XG4gIGV4cG9zZWRNb2R1bGU6IHN0cmluZztcbn07XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbG9hZFJlbW90ZU1vZHVsZTxUID0gYW55PihcbiAgb3B0aW9uczogTG9hZFJlbW90ZU1vZHVsZU9wdGlvbnNcbik6IFByb21pc2U8VD4ge1xuICBsZXQgbG9hZFJlbW90ZUVudHJ5T3B0aW9uczogTG9hZFJlbW90ZUVudHJ5T3B0aW9ucztcbiAgbGV0IGtleTogc3RyaW5nO1xuICBsZXQgcmVtb3RlRW50cnk6IHN0cmluZztcblxuICAvLyBUbyBzdXBwb3J0IGxlZ2FjeSBBUEkgKDwgbmcgMTMpXG4gIGlmICghb3B0aW9ucy50eXBlKSB7XG4gICAgb3B0aW9ucy50eXBlID0gJ3NjcmlwdCc7XG4gIH1cblxuICBpZiAob3B0aW9ucy50eXBlID09PSAnbWFuaWZlc3QnKSB7XG4gICAgY29uc3QgbWFuaWZlc3RFbnRyeSA9IGNvbmZpZ1tvcHRpb25zLnJlbW90ZU5hbWVdO1xuICAgIGlmICghbWFuaWZlc3RFbnRyeSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNYW5pZmVzdCBkb2VzIG5vdCBjb250YWluICcgKyBvcHRpb25zLnJlbW90ZU5hbWUpO1xuICAgIH1cbiAgICBvcHRpb25zID0ge1xuICAgICAgdHlwZTogbWFuaWZlc3RFbnRyeS50eXBlLFxuICAgICAgZXhwb3NlZE1vZHVsZTogb3B0aW9ucy5leHBvc2VkTW9kdWxlLFxuICAgICAgcmVtb3RlRW50cnk6IG1hbmlmZXN0RW50cnkucmVtb3RlRW50cnksXG4gICAgICByZW1vdGVOYW1lOlxuICAgICAgICBtYW5pZmVzdEVudHJ5LnR5cGUgPT09ICdzY3JpcHQnID8gb3B0aW9ucy5yZW1vdGVOYW1lIDogdW5kZWZpbmVkLFxuICAgIH07XG4gICAgcmVtb3RlRW50cnkgPSBtYW5pZmVzdEVudHJ5LnJlbW90ZUVudHJ5O1xuICB9IGVsc2Uge1xuICAgIHJlbW90ZUVudHJ5ID0gb3B0aW9ucy5yZW1vdGVFbnRyeTtcbiAgfVxuXG4gIGlmIChvcHRpb25zLnR5cGUgPT09ICdzY3JpcHQnKSB7XG4gICAgbG9hZFJlbW90ZUVudHJ5T3B0aW9ucyA9IHtcbiAgICAgIHR5cGU6ICdzY3JpcHQnLFxuICAgICAgcmVtb3RlRW50cnk6IG9wdGlvbnMucmVtb3RlRW50cnksXG4gICAgICByZW1vdGVOYW1lOiBvcHRpb25zLnJlbW90ZU5hbWUsXG4gICAgfTtcbiAgICBrZXkgPSBvcHRpb25zLnJlbW90ZU5hbWU7XG4gIH0gZWxzZSBpZiAob3B0aW9ucy50eXBlID09PSAnbW9kdWxlJykge1xuICAgIGxvYWRSZW1vdGVFbnRyeU9wdGlvbnMgPSB7XG4gICAgICB0eXBlOiAnbW9kdWxlJyxcbiAgICAgIHJlbW90ZUVudHJ5OiBvcHRpb25zLnJlbW90ZUVudHJ5LFxuICAgIH07XG4gICAga2V5ID0gb3B0aW9ucy5yZW1vdGVFbnRyeTtcbiAgfVxuXG4gIGlmIChyZW1vdGVFbnRyeSkge1xuICAgIGF3YWl0IGxvYWRSZW1vdGVFbnRyeShsb2FkUmVtb3RlRW50cnlPcHRpb25zKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCBsb29rdXBFeHBvc2VkTW9kdWxlPFQ+KGtleSwgb3B0aW9ucy5leHBvc2VkTW9kdWxlKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNldE1hbmlmZXN0KFxuICBtYW5pZmVzdDogTWFuaWZlc3RGaWxlLFxuICBza2lwUmVtb3RlRW50cmllcyA9IGZhbHNlXG4pIHtcbiAgY29uZmlnID0gcGFyc2VDb25maWcobWFuaWZlc3QpO1xuXG4gIGlmICghc2tpcFJlbW90ZUVudHJpZXMpIHtcbiAgICBhd2FpdCBsb2FkUmVtb3RlRW50cmllcygpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNYW5pZmVzdDxUIGV4dGVuZHMgTWFuaWZlc3Q+KCk6IFQge1xuICByZXR1cm4gY29uZmlnIGFzIFQ7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkTWFuaWZlc3QoXG4gIGNvbmZpZ0ZpbGU6IHN0cmluZyxcbiAgc2tpcFJlbW90ZUVudHJpZXMgPSBmYWxzZVxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZldGNoKGNvbmZpZ0ZpbGUpO1xuXG4gIGlmICghcmVzdWx0Lm9rKSB7XG4gICAgdGhyb3cgRXJyb3IoJ2NvdWxkIG5vdCBsb2FkIGNvbmZpZ0ZpbGU6ICcgKyBjb25maWdGaWxlKTtcbiAgfVxuXG4gIGNvbmZpZyA9IHBhcnNlQ29uZmlnKGF3YWl0IHJlc3VsdC5qc29uKCkpO1xuXG4gIGlmICghc2tpcFJlbW90ZUVudHJpZXMpIHtcbiAgICBhd2FpdCBsb2FkUmVtb3RlRW50cmllcygpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHBhcnNlQ29uZmlnKGNvbmZpZzogTWFuaWZlc3RGaWxlKTogTWFuaWZlc3Qge1xuICBjb25zdCByZXN1bHQ6IE1hbmlmZXN0ID0ge307XG4gIGZvciAobGV0IGtleSBpbiBjb25maWcpIHtcbiAgICBjb25zdCB2YWx1ZSA9IGNvbmZpZ1trZXldO1xuXG4gICAgbGV0IGVudHJ5OiBSZW1vdGVDb25maWc7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGVudHJ5ID0ge1xuICAgICAgICByZW1vdGVFbnRyeTogdmFsdWUsXG4gICAgICAgIHR5cGU6ICdtb2R1bGUnLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgZW50cnkgPSB7XG4gICAgICAgIC4uLnZhbHVlLFxuICAgICAgICB0eXBlOiB2YWx1ZS50eXBlIHx8ICdtb2R1bGUnLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXN1bHRba2V5XSA9IGVudHJ5O1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvYWRSZW1vdGVFbnRyaWVzKCkge1xuICBjb25zdCBwcm9taXNlczogUHJvbWlzZTx2b2lkPltdID0gW107XG5cbiAgZm9yIChsZXQga2V5IGluIGNvbmZpZykge1xuICAgIGNvbnN0IGVudHJ5ID0gY29uZmlnW2tleV07XG5cbiAgICBpZiAoZW50cnkudHlwZSA9PT0gJ21vZHVsZScpIHtcbiAgICAgIHByb21pc2VzLnB1c2goXG4gICAgICAgIGxvYWRSZW1vdGVFbnRyeSh7IHR5cGU6ICdtb2R1bGUnLCByZW1vdGVFbnRyeTogZW50cnkucmVtb3RlRW50cnkgfSlcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHByb21pc2VzLnB1c2goXG4gICAgICAgIGxvYWRSZW1vdGVFbnRyeSh7XG4gICAgICAgICAgdHlwZTogJ3NjcmlwdCcsXG4gICAgICAgICAgcmVtb3RlRW50cnk6IGVudHJ5LnJlbW90ZUVudHJ5LFxuICAgICAgICAgIHJlbW90ZU5hbWU6IGtleSxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xufVxuIl19